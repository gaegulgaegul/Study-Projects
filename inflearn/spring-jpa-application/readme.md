# Spring JPA 기반 웹 애플리케이션 개발

> 이 프로젝트는 인프런 백기선님의 강의를 듣고 정리하기 위한 프로젝트 입니다.

- 프로젝트 생성
    - [dependency](pom.xml) 추가
- [Account](./src/main/java/com/studyolle/domain/Account.java) 도메인 클래스
    - @EqualsAndHashCode
        - 연관관계가 복잡해질 때 `@EqualsAndHashCode`에서 순환참조 하면서 무한루프가 발생하여 StackOverFlow가 발생할 수 있다.
        - Id만 등록하고 사용한다.
        - 자세한 설명은 Rest API 강의에서 확인
    - @Lob
        - VARCHAR(255)보다 큰 값이 들어오는 경우 설정
    - @Basic(fetch = FetchType.EAGER)
        - 컬럼의 기본 타입을 매핑해준다.
        - 기본 Lazy
- 회원가입
    - GET "/sign-up" 요청을 받아서 account/sign-up.html 페이지를 보여준다.
    - [AccountController](./src/main/java/com/studyolle/account/AccountController.java)
        - [model](./src/main/java/com/studyolle/account/SignUpForm.java) 정보 전달(닉네임, 이메일, 패스워드)
            - `model.addAttribute(객체)`와 같이 설정하면 자동으로 키는 객체 타입명이 카멜 케이스로 전달된다. 
    - [AccountControllerTest](./src/test/java/com/studyolle/account/AccountControllerTest.java)
        - `@AutoConfigureMockMvc`: MockMvc 자동 설정 추가
        - view, model 테스트
    - [Spring Security 설정](./src/main/java/com/studyolle/config/SecurityConfig.java)
        - 허용할 화면 설정
        - static resources 설정
        - CSRF
            - spring security에서 공격을 막지만 thymeleaf의 form 전송의 경우 자동으로 _csrf 토큰을 생성해 전송하고 해당 토큰 값을 검증한다.
    - 폼 검증
        - [JSR 303 애노테이션 검증](./src/main/java/com/studyolle/account/SignUpForm.java)
            - 값의 길이, 필수값
        - [커스텀 검증](./src/main/java/com/studyolle/account/SignUpFormValidator.java)
            - 중복 이메일, 닉네임 여부 확인
        - 폼 에러 있을 시, 폼 다시 보여주기
    - [회원가입 처리](./src/main/java/com/studyolle/account/AccountService.java)
        - 회원 정보 저장
        - 인증 이메일 발송
        - 처리 후 첫 페이지로 리다이렉트(Post-Redirect-Get 패턴)
    - 패스워드 인코더
        - 해시 알고리즘
            - 개인정보를 암호화 하여 평문으로 보이지 않도록 한다.
        - 솔트(salt)
            - 평문 개인정보에 솔트 값을 더하여 암호화 한다.
            - 솔트 값은 매번 랜덤한 값이 나온다. 인코딩할 때 솔트 값을 추가하게 된다.
            - 해시 알고리즘 특정 상 (평문 개인정보 + 해시된 개인정보)를 다시 해싱하면 원래 해시값이 나오게 된다. 솔트 값이 랜덤해도 상관없다.
        - 스프링 시큐리티 권장 PasswordEncoder
            - `PasswordEncoderFactories.createDelegatingPasswordEncoder()`
            - 여러 해시 알고리즘을 지원하는 패스워드 인코더
            - bcrypt는 다른 해시 알고리즘에 비해 의도적으로 해시되는 속도가 느리다. 해커들이 여러번 시도할 수 없도록 하기 위해
    - 인증 메일 확인
        - `GET /check-email-token token=${token} email=${email} 요청 처리`
          - 이메일이 정확하지 않은 경우에 대한 에러 처리
          - 토큰이 정확하지 않은 경우에 대한 에러 처리
          - 이메일과 토큰이 정확한 경우 가입 완료 처리
              - 가입일시 설정
              - 이메일 인증 여부 true로 설정
    - 자동 로그인
        - 회원가입 후 바로 로그인 되도록 한다.
        - `UsernamePasswordAuthenticationToken`을 [사용](./src/main/java/com/studyolle/account/AccountService.java)한다.
            - AuthenticationManager 내부에서 사용하도록 만든 클래스로 원래는 다른 방식으로 사용해야 한다.
            - 정석대로 사용하는 방법
            ```java
              UsernamePasswordAuthenticationToken token = new UsernamePasswordAuthenticationToken(nickname, password); // 토큰 조회
              Authentication authentication = authenticationManager.authenticate(token); // 역할 부여
              SecurityContextHolder.getContext().setAuthentication(authentication); // authentication 설정
            ```
    - 프론트엔드 라이브러리 정리
        - WebJar
            - Maven Repository에서 확인할 수 있다.
            - spring 진영에서 패키지화 해서 사용할 수 있도록 한다.
            - 라이브러리 업데이트가 늦다.
        - npm
            - src/main/resource/static 하위에 package.json을 사용하여 라이브러리를 받아와서 정적 리소스로 사용할 수 있다.
            - 메이븐 빌드 시 static 디렉터리의 package.json를 빌드하도록 설정해야 한다.
    - Thymeleaf fragment
        - 정의
            - `th:fragment`
        - 사용
            - `th:insert`: 삽입
            - `th:replace`: 치환
    - 현재 인증된 사용자 정보 참조
        - 스프링 시큐리티의 스프링 웹 MVC 지원
            - @AuthenticationPrincipal
                - 핸들러 매개변수로 현재 인증된 Principal을 참조할 수 있다.
            - 스프링 시큐리티 정보와 Account 사이의 간극을 메우기 위해 [UserAccount](./src/main/java/com/studyolle/account/UserAccount.java)를 생성한다.
                - 스프링 시큐리티의 User 상속
    - 로그인 기능
        - `UserDetailsService` 상속받아 [구현](./src/main/java/com/studyolle/account/AccountService.java)해야 한다.
        - Spring Security login/logout 설정
        - [로그인 기억하기(RememberMe)](./src/main/java/com/studyolle/config/SecurityConfig.java)
            - 세션이 만료되더라도 로그인을 유지하고 싶을 때 사용하게 된다.
            - username, token(변경됨), series(변경되지 않음)을 조합해서 쿠키값이 생성된다.
            - `persistent_logins` 메타 테이블을 생성해줘야 한다.
            - `remember-me`를 key로 전달받아 사용한다. (설정을 통해 변경 가능하다.)
    - 프로필 기능
        - 프로필 확인 기능
            - 이메일 인증 후 프로필에 반영 안되는 오류
                - 이메일 인증 처리 로직은 트랜잭션 범위 밖에서 일어난 일이다.
                - service로 트랜잭션을 위임한다.
            - Open EntityManager In View Filter
                - JPA EntityManager를 요청을 처리하는 전체 프로세스에 바인딩 시켜주는 필터
                    - 뷰를 랜더링 할때까지 영속성 컨텍스트를 유지하기 때문에 필요한 데이터를 랜더링 하는 시점에 추가로 읽어올 수 있다.
                    - 엔티티 객체 변경은 반드시 트랜잭션 안에서 할 것
                        - 트랜잭션 종료 직전 또는 필요한 시점에 변경사항을 DB에 반영
        - 프로필 수정
            - form 생성
                - controller에서 model을 통해 현재 유저, 유저의 profile 정보를 전달한다.
            - 프로필 수정 기능
                - controller 파라미터 객체
                    - `@CurrentUser Account account, @Valid [@ModelAttribute(생략)] Profile profile, Errors errors, Model model` 파라미터로 받는다.
                    - `@ModelAttribute` 옆에 항상 Errors가 있어야 한다. 해당 `@ModelAttribute`에 대한 에러 처리
                - profile 데이터 바인딩 시에 오류
                    - 파라미터로 전달 받는 데이터를 객체에 바인딩 할 떄 해당 객체를 기본 생성자로 만들어주고 setter를 통해 데이터를 바인딩한다.
                    - 기본 생성자(`@NoArgsConstructor`)가 없으면 `NullPointerException` 발생
                - account 업데이트가 안되는 문제
                    - account는 session에서 받아온 객체라서 persist 상태가 아니기 때문에 PersistContext가 관리하지 않는다.
                    - Repository를 통해 save 해준다.
                - RedirectAttributes
                    - 리다이렉트 시 데이터를 전달할 수 있다.
                    - addFlashAttribute
                        - 리다이렉트 시 한번 사용하고 없어지는 데이터 전달
                        - 데이터는 리다이렉트 되는 엔드포인트 `Model` 객체에 자동으로 전달된다.